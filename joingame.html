<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Tip Tap</title>
    </head>
    <body>
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
        <h1>Tip Tap
        </h1>
        <div id="clientIdContainer"></div>
        <div id="gameIdContainer"></div>
        <input type='text' id='txtGameId'>
        <button id='btnJoin'>Join Game</button>
        <div id="chatContainer">Chat</div>
        <input type="text" id="txtChat"><button id="btnSendChat">Send >
        </button>
        <div id='divPlayers'>Players Joined</div>
        <div id="boardImage"></div>
        <div id="diceContainer">
            Dice(s)
        </div>
        <div id="tokenContainer">Tokens</div>

        <!-- Draggable DIV -->
        <!-- <div
            id="mydiv" style="position:absolute">
            <! Include a header DIV with the same name as the draggable DIV, followed by "header" -->
            <!-- <div id="mydivheader" style="cursor:move">TOKEN</div> -->
        <!-- </div> --> 

        <script>
            // HTML elements
            let clientId = null;
            let gameId = null;
            let playerColor = null;
            let boardImagelink = null;
            let activetokenId=null;
            let ws = new WebSocket("ws://localhost:9090");
            // let ws=new WebSocket("ws://f96a080c7b81.ngrok.io");
            

            const btnJoin = document.getElementById("btnJoin");
            const btnSendChat = document.getElementById("btnSendChat");
            const txtChat = document.getElementById("txtChat");
            const divPlayers = document.getElementById("divPlayers");
            const gameIdContainer = document.getElementById("gameIdContainer");
            const clientIdContainer = document.getElementById("clientIdContainer");
            const chatContainer = document.getElementById("chatContainer");
            const boardImage = document.getElementById("boardImage");
            const tokenscolorarray = [];
            const tokensnoarray = [];
            const tokenContainer = document.getElementById("tokenContainer");
            const diceContainer=document.getElementById("diceContainer");

            // wiring events
            btnJoin.addEventListener("click", e => {

                if (gameId === null) 
                    gameId = txtGameId.value;
                
                const payLoad = {
                    "method": "join",
                    "clientId": clientId,
                    "gameId": gameId
                }
                ws.send(JSON.stringify(payLoad));

            })

            btnSendChat.addEventListener("click", e => {
                const payload = {
                    "method": "chat",
                    "clientId": clientId,
                    "color": playerColor,
                    "gameId": gameId,
                    "chattext": txtChat.value
                }
                ws.send(JSON.stringify(payload));

                txtChat.value = "";
            })

            // ----DRAG DROP SYNC---//
            // Make the DIV element draggable:
            

            function dragElement(elmnt) {
                var pos1 = 0,
                    pos2 = 0,
                    pos3 = 0,
                    pos4 = 0;
                if (document.getElementById(elmnt.id + "header")) { // if present, the header is where you move the DIV from:
                    document.getElementById(elmnt.id + "header").onmousedown = dragMouseDown;
                } else { // otherwise, move the DIV from anywhere inside the DIV:
                    elmnt.onmousedown = dragMouseDown;
                }

                function dragMouseDown(e) {
                    e = e || window.event;
                    e.preventDefault();
                    // get the mouse cursor position at startup:
                    pos3 = e.clientX;
                    pos4 = e.clientY;
                    document.onmouseup = closeDragElement;
                    // call a function whenever the cursor moves:
                    document.onmousemove = elementDrag;
                }

                function elementDrag(e) {
                    e = e || window.event;
                    e.preventDefault();
                    // calculate the new cursor position:
                    pos1 = pos3 - e.clientX;
                    pos2 = pos4 - e.clientY;
                    pos3 = e.clientX;
                    pos4 = e.clientY;
                    // set the element's new position:
                    elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
                    elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
                    activetokenId=elmnt.id;

                    const payload = {
                        "method": "updatepos",
                        "xpos": elmnt.style.left,
                        "ypos": elmnt.style.top,
                        "gameId": gameId,
                        "clientId": clientId,
                        "activetokenId":activetokenId
                    }
                    ws.send(JSON.stringify(payload));
                }

                function closeDragElement() { // stop moving when mouse button is released:
                    document.onmouseup = null;
                    document.onmousemove = null;
                }
            }


            // message recieved from ws server
            ws.onmessage = message => { // message.data
                const response = JSON.parse(message.data);
                console.log(response);
                // connect
                if (response.method === "connect") {
                    clientId = response.clientId;
                    clientIdContainer.innerHTML = "ClientId: " + clientId;
                    console.log("Client id Set successfully " + clientId)
                }
                
                if (response.method === "chat") {

                    //INCLUDES CSS
                    chattext = response.chattext;
                    color = response.color;
                    let chatBoxItem = document.createElement("div");
                    chatBoxItem.innerHTML = "<span style='color:"+color+"'>" + color + ": </span>"+ chattext;
                    chatContainer.appendChild(chatBoxItem);
                }
                if (response.method === "updatepos") {
                    if (response.clientId != clientId) {
                        let xpos = response.xpos;
                        let ypos = response.ypos;
                        activetokenId=response.activetokenId;
                        document.getElementById(activetokenId).style.top = ypos;
                        document.getElementById(activetokenId).style.left = xpos;
                    }
                }
                if(response.method==="updatedice"){
                    document.getElementById(response.diceId).innerHTML=response.value;
                }

                // join
                if (response.method === "join") {
                    const game = response.game;
                    gameIdContainer.innerHTML = "GameId: " + gameId;
                    boardImagelink = game.boardImage;
                    //INCLUDES CSS
                    boardImage.innerHTML = "<img src='" + boardImagelink + "' >"

                    while (divPlayers.firstChild) 
                        divPlayers.removeChild(divPlayers.firstChild);
                    
                    // active players
                    game.clients.forEach(c => {
                        //INCLUDES CSS
                        const d = document.createElement("div");
                        d.style.width = "200px";
                        d.style.background = c.color;
                        d.style.color = "white";
                        d.textContent = c.clientId;
                        divPlayers.appendChild(d);

                        if (c.clientId === clientId) 
                            playerColor = c.color;
                    })
                    
                    // dice and token creation
                    if(game.clients.length==game.tokenscolorarray.length){
                        for(let diceCount=0;diceCount<game.noofDice;diceCount++){
                            const dice=document.createElement("div");
                            //INCLUDES CSS
                            dice.style.width=30+"px";
                            dice.style.height=30+"px";
                            dice.style.backgroundColor="grey";
                            dice.style.margin=2+"px";
                            dice.style.color="white";
                            dice.style.textAlign="center";
                            dice.style.fontSize=20+"px";
                            dice.style.borderRadius=5+"px";
                            dice.id="dice"+diceCount;
                            dice.style.cursor="pointer";
                            dice.addEventListener("click",e=>{
                                var randomInt=Math.floor(Math.random() * 7);
                                if(randomInt===0) randomInt=1;
                                dice.innerHTML=randomInt;
                                const payLoad={
                                    "method":"updatedice",
                                    "diceId":dice.id,
                                    "value":randomInt,
                                    "gameId":gameId,
                                    "clientId":clientId
                                }
                                ws.send(JSON.stringify(payLoad));
                            })
                            diceContainer.appendChild(dice);
                        }
                    for(let playerCount=0;playerCount<game.tokenscolorarray.length;playerCount++){
                        tokenscolorarray[playerCount]=game.tokenscolorarray;
                        for(let tokenCount=0;tokenCount<game.tokensnoarray[playerCount];tokenCount++){
                            tokensnoarray[playerCount]=game.tokensnoarray[playerCount];
                            const token=document.createElement("div");
                            token.style.backgroundColor=game.tokenscolorarray[playerCount];
                            token.style.position='absolute';
                            token.id=game.tokenscolorarray[playerCount]+tokenCount;
                            const innertoken=document.createElement("div");
                            innertoken.id=token.id+"header";
                            innertoken.style.cursor="move";
                            //INCLUDES CSS
                            innertoken.style.width=20+"px";
                            innertoken.style.height=20+"px";
                            token.style.borderRadius=25+"px";
                            token.appendChild(innertoken);
                            tokenContainer.appendChild(token);
                            dragElement(token);                
                        }
                    }}

                }
            }
            console.log(tokenscolorarray);
            console.log(tokensnoarray);
        </script>
    </body>
</html>
